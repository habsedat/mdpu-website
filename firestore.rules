rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.get('role', '') == 'admin';
    }
    
    function isAdminClaim() {
      return isAuthenticated() && 
             (request.auth.token.get('role', '') == 'admin' || 
              request.auth.token.get('role', '') == 'superadmin' ||
              request.auth.uid == 'cE2LxjTCDTWDxesSYHtLN9sTnpn1'); // Temporary: allow your specific UID
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             request.auth.token.get('role', '') == 'superadmin';
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Public collections (read-only for non-admins)
    match /members/{document} {
      allow read: if true;
      allow write: if isAdminClaim();
    }
    
    match /projects/{document} {
      allow read: if true;
      allow write: if isAdminClaim();
    }
    
    match /events/{document} {
      allow read: if true;
      allow write: if isAdminClaim();
    }
    
    // Applications - users can create, admins can read/write all
    match /applications/{document} {
      allow create: if true; // Allow public application submissions
      allow read: if isAdminClaim() || isOwner(uid);
      allow update, delete: if isAdminClaim() || isOwner(uid);
    }
    
    // Profiles - private, only owner and admins can access
    match /profiles/{uid} {
      allow read, write: if isOwner(uid) || isAdminClaim();
      allow create, delete: if isAdminClaim();
    }
    
    // Payments - readable by owner or admin, no client writes
    match /payments/{document} {
      allow read: if isOwner(resource.data.uid) || isAdminClaim();
      allow write: if false; // Only server/webhooks can write
    }
    
    // Reports - admin only
    match /reports/{document=**} {
      allow read: if isAdminClaim();
      allow write: if false; // Only server functions can write
    }
    
    // Media metadata
    match /media/{document} {
      allow read: if true;
      allow write: if isAdminClaim();
    }
    
    // Roles collection - source of truth for admin roles
    match /roles/{uid} {
      allow read: if isAdminClaim() || isOwner(uid);
      allow write: if false; // Only callable functions can write
    }
    
    // Admin invites collection - superadmin readable, functions writable
    match /adminInvites/{inviteId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only callable functions can write
    }
    
    // Admin audit log - superadmin readable only
    match /adminAudit/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only callable functions can write
    }
  }
}

